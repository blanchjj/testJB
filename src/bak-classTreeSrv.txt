import { Injectable } from '@angular/core';
import { Headers, Http } from '@angular/http';
import 'rxjs/add/operator/toPromise';

import {ClassTreeNode} from './class-tree-node';

@Injectable()
export class ClassTreeService {

private headers = new Headers({'Content-Type': 'application/json'});
private treeUrl = 'api/classTree';  // URL to web api
private classTreeJson: string = '';


constructor(private http: Http) { }


// Get tree data
get(): Promise<any> {
    return this.http.get(this.treeUrl)
                .toPromise()
                .then(response => this.prepTree(response.json().data as ClassTreeNode[])  )
                .catch(this.handleError)
}


// Add a node
add(classTreeNode:ClassTreeNode): Promise<ClassTreeNode> {

    return this.http
        .post(this.treeUrl, JSON.stringify(classTreeNode), {headers: this.headers})
        .toPromise()
        .then(res => res.json().data as ClassTreeNode)
        .catch(this.handleError);

}

// Update a node
update(classTreeNode:ClassTreeNode): Promise<ClassTreeNode> {
    const url = `${this.treeUrl}/${classTreeNode.id}`;

    return this.http
        .put(url, JSON.stringify(classTreeNode), {headers: this.headers})
        .toPromise()
        .then(() => classTreeNode)
        .catch(this.handleError);
}

// Delete a node
delete(id: number): Promise<void> {
    const url = `${this.treeUrl}/${id}`;

    return this.http.delete(url, {headers: this.headers})
        .toPromise()
        .then(() => null)
        .catch(this.handleError);
}



// Need to convert result set from API into format compatible with ag-grid tree
private prepTree(data:ClassTreeNode[]):any {

    var nullClassTreeNode: ClassTreeNode = {
            id: null,
            seq: null,
            name: null,
            parentId: null,
            parent: null,
            level: null,
            openForBid: null,
            openForOffre: null,
            checked: null,
            DisplayPath: null,
            inheritFromParent: null,
            car1: null,
            car2: null,
            cae3: null
        }

    this.classTreeJson = '[ \n';

    //console.log('ARRAY:' + JSON.stringify(data) );

    this.prepTree2(nullClassTreeNode, data, 0 );

    this.classTreeJson += ']';

    //console.log(this.classTreeJson);

    //return this.getTree();
    return JSON.parse(this.classTreeJson);
    
}


prepTree2(leaf: ClassTreeNode, data: ClassTreeNode[], level: number ) {

    var childList: ClassTreeNode[] = [];
    var first: boolean;

    // output the current node if not the first level in that case leaf is null
    if (leaf.id != null) {
        //this.buf = JSON.stringify(leaf) + '\n';
        leaf.level = level;
        this.classTreeJson += '{ \n  ' + JSON.stringify(leaf).replace('{','').replace('}','') ;
    }

    // Build and order list of the children
    for (let e of data) {
        if (e.parentId == leaf.id) {
            childList.push(e)
        } 
        //console.log(e);
    }
    
    if (childList.length != 0) {
        // here we need to order the list
    
        if (leaf.id != null) {
            this.classTreeJson += ',\n  "children": [ \n';
        }
        // process each child
        first=true;
        for (let e2 of childList) {
            //if not first need a comma
            if (! first) {
                this.classTreeJson += ',\n'
            }
            this.prepTree2(e2, data, level += 1)
            first=false;
        }

        if (leaf.id != null) {
            this.classTreeJson += '] \n';
        }
    }

    if (leaf.id != null) {
        this.classTreeJson += '}';
    }
}


private handleError(error: any): Promise<any> {
  console.error('An error occurred', error); // for demo purposes only
  return Promise.reject(error.message || error);
}









// to delete
public getTree(): any {

return [

            {name: "FEDERAL", xxx1: false, bidMktOpen: true, parent: true, level: 1, checked: true,
                children: [
                    {name: "CANADA", bidMktOpen: true, xxx1: false, texte: 'abcde' }
                ]
            },

            {name: "PROVINCIAL", bidMktOpen: false, xxx1:false, parent: true, level: 1, checked: true,
                children: [
                    {name: "QUEBEC", bidMktOpen: true, xxx1: true},
                    {name: "ONTARIO", bidMktOpen: false, xxx1: true, texte:'12345'},
                    {name: "BC", bidMktOpen: true, xxx1: false},
                    {name: "ALBERTA", bidMktOpen: true, xxx1: true}
                ]
            },

            {name: "CORP", bidMktOpen: false, xxx1: false, parent: true, level: 1, checked: true,
            children: [
                {name: "BANKS", bidMktOpen: false, xxx1: false, parent: true, level: 2, checked: true,
                children: [
                    {name: "RY", bidMktOpen: true, xxx1: true, parent: true, level: 3, checked: true,
                    children: [
                        {name: "SENIOR", bidMktOpen: true, xxx1: true, level: 4},
                        {name: "NVCC", bidMktOpen: true, xxx1: true, level: 4}
                    ]},
                    {name: "NB", bidMktOpen: true, xxx1: true, parent: true, level: 3, checked: true,
                    children: [
                        {name: "SENIOR", bidMktOpen: true, xxx1: true, level: 4},
                        {name: "NVCC", bidMktOpen: true, xxx1: true, level: 4}
                    ]},
                    {name: "CIBC", bidMktOpen: true, xxx1: true, parent: true, level: 3, checked: true,
                    children: [
                        {name: "SENIOR", bidMktOpen: true, xxx1: true, level: 4},
                        {name: "NVCC", bidMktOpen: true, xxx1: true, level: 4}
                    ]},
                    {name: "BNS", bidMktOpen: true, xxx1: true, parent: true, level: 3, checked: true,
                    children: [
                        {name: "SENIOR", bidMktOpen: true, xxx1: true, level: 4},
                        {name: "NVCC", bidMktOpen: true, xxx1: true, level: 4}
                    ]},
                    {name: "BMO", bidMktOpen: true, xxx1: true, parent: true, level: 3, checked: true,
                    children: [
                        {name: "SENIOR", bidMktOpen: true, xxx1: true, level: 4},
                        {name: "NVCC", bidMktOpen: true, xxx1: true, level: 4}
                    ]},
                    {name: "TD", bidMktOpen: true, xxx1: true, parent: true, level: 3, checked: true,
                    children: [
                        {name: "SENIOR", bidMktOpen: true, xxx1: true, level: 4},
                        {name: "NVCC", bidMktOpen: true, xxx1: true, level: 4}
                    ]}

                ]
            },
            {name: "RETAILOR", bidMktOpen: true, xxx1: true, level: 2},
            {name: "TELCO", bidMktOpen: true, xxx1: true, level: 2},
            {name: "POWER GENERATORS", bidMktOpen: true, xxx1: true, level: 2}

            ]
        }
]

}


}